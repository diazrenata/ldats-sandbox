---
title: "Composite LL"
output: github_document
---

Calculating composite loglikelihood for all model specifications using leave-one-out cross validation.

Per model specification (number of changepoints, number of topics, LDA seed, covariates), fit one model to one dataset for every year of data. Every dataset has a focal year, plus a 2 year buffer on either side, witheld for model fitting. Then we calculate estimates of the likelihood of that focal year of data given the model, using estimates of the model parameters. We assemble a full timeseries likelihood by adding together loglikelihoods for every year, scrambling the (probably arbitrary) iterations that get combined. This gives us an estimated loglikelihood measuring performance of the model specification across all the years of data. 

I tried using likelihood (not log), but the numbers were too small for R. 

I had some internal debate over whether to keep LDA seeds fixed or try to incorporate variation between LDA models of the same k but different seed. I decided not to go there, because it seemed mathematically dubious and also like an organizational nightmare. 


## Model specifications

- 3 seeds
- 0 or 1 changepoint
- I am currently running a set with 2 changepoints.
- 2, 3, or 6 topics
- ~1 or ~year
- 1000 iterations

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(matssldats)
library(drake)
library(ggplot2)
library(dplyr)

## Set up the cache and config
db <- DBI::dbConnect(RSQLite::SQLite(), here::here("drake", "drake-cache-sim.sqlite"))
cache <- storr::storr_dbi("datatable", "keystable", db)

```

```{r load composite ll}

loadd(composite_ll_rdat_noisy, composite_ll_rdat_sim, cache = cache)

composite_ll <- bind_rows(mutate(composite_ll_rdat_noisy, source = "noisy"), mutate(composite_ll_rdat_sim, source = "sim"))

```

## Loglikelihood for all models

The y-axis is loglikelihood across all years. The x axis is the number of topics. The very short color scale is the seed (included to split the box plots). The facet columns are number of changepoints and the rows are formula (top is ~1, bottom is ~time). Variation represents variation in estimates of the likelihood from different parameter estimates (1000 draws).

```{r plots, fig.height = 10, fig.width = 8}

composite_ll <- composite_ll %>%
  mutate(k = as.factor(k),
         ncpt = as.factor(ncpt),
         seed = as.factor(seed))

all_var <- ggplot(data = composite_ll, aes(x = k, y = sum_ll, color = seed)) +
  geom_boxplot() +
  #  geom_jitter(aes(shape = seed), alpha = .5) +
  facet_wrap(vars(form, ncpt, source)) +
  theme_bw() +
  scale_color_viridis_d(begin = .01, end = .2)

all_var
```

### Mean loglikelihood

This is the same plot as above, but only plotting the mean loglikelihood across all estimates for each model specification.  

```{r summarize}

smooth_draws <- composite_ll %>%
  group_by(k, seed, form, ncpt, source) %>%
  summarize(mean_llik = mean(sum_ll)) %>%
  ungroup() 

sd_plot <- ggplot(data = smooth_draws, aes(x = k, y = mean_llik, color = seed)) +
  geom_jitter(height = 0, width = .1) +
  facet_wrap(vars(source, form, ncpt)) +
  theme_bw() +
  scale_color_viridis_d(begin = .01, end = .2)


sd_plot

```
